// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

enum UserRole {
  AGENT
  MANAGER
  ADMINISTRATOR
  EXECUTIVE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

model User {
  id                String         @id @default(uuid())
  email             String         @unique
  firstName         String
  lastName          String
  phone             String?
  profilePhoto      String?
  role              UserRole       @default(AGENT)
  status            UserStatus     @default(PENDING)
  emailVerified     Boolean        @default(false)
  mfaEnabled        Boolean        @default(false)
  lastLoginAt       DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  profile           UserProfile?
  organizations     OrganizationMember[]
  contracts         Contract[]
  instructorCourses Course[]       @relation("InstructorCourses")
  enrollments       Enrollment[]   @relation("UserEnrollments")
  certifications    Certification[] @relation("UserCertifications")
  instructorEvents  TrainingEvent[] @relation("InstructorEvents")
  eventAttendances  EventAttendee[] @relation("EventAttendances")
  uploadedResources Resource[]     @relation("UploadedResources")
  favoriteResources ResourceFavorite[] @relation("FavoriteResources")
  cases             Case[]
  quotes            Quote[]
  commissions       Commission[]
  notifications     Notification[]
  auditLogs         AuditLog[]
  goals             Goal[]

  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

model UserProfile {
  id                  String    @id @default(uuid())
  userId              String    @unique
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // License Information
  licenseNumber       String?
  licenseState        String?
  licenseExpiration   DateTime?
  npn                 String?   @unique // National Producer Number

  // Professional Details
  gaid                String?   @unique // General Agent ID
  agencyName          String?
  yearsOfExperience   Int?
  specializations     String[]
  photoUrl            String?   // Profile photo URL from Supabase Storage

  // Notification Preferences
  emailNotifications  Boolean   @default(true)
  smsNotifications    Boolean   @default(false)
  pushNotifications   Boolean   @default(true)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([npn])
  @@index([gaid])
  @@map("user_profiles")
}

// ============================================
// ORGANIZATION HIERARCHY
// ============================================

model Organization {
  id              String               @id @default(uuid())
  name            String
  type            String               // MGA, IMO, Agency, etc.
  parentId        String?
  parent          Organization?        @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children        Organization[]       @relation("OrganizationHierarchy")

  // Organization Details
  ein             String?              @unique // Employer Identification Number
  phone           String?
  email           String?
  address         String?
  city            String?
  state           String?
  zipCode         String?

  status          UserStatus           @default(ACTIVE)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Relations
  members         OrganizationMember[]
  contracts       Contract[]

  @@index([parentId])
  @@index([type])
  @@map("organizations")
}

model OrganizationMember {
  id              String       @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  role            UserRole     @default(AGENT)
  commissionSplit Float?       // Percentage as decimal (e.g., 0.50 for 50%)
  permissions     String[]     @default([]) // Custom permissions for this user in this organization
  isActive        Boolean      @default(true)
  joinedAt        DateTime     @default(now())
  leftAt          DateTime?

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

// ============================================
// CONTRACTS
// ============================================

enum ContractStatus {
  PENDING
  APPROVED
  ACTIVE
  INACTIVE
  REJECTED
}

model Contract {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id])
  organizationId    String?
  organization      Organization?  @relation(fields: [organizationId], references: [id])

  carrierName       String
  productType       String         // Life, Annuity, Health, etc.
  contractNumber    String?
  commissionLevel   Float?         // Percentage as decimal
  status            ContractStatus @default(PENDING)
  effectiveDate     DateTime?
  expirationDate    DateTime?

  // Documents
  documentUrls      String[]

  requestedAt       DateTime       @default(now())
  approvedAt        DateTime?
  updatedAt         DateTime       @updatedAt

  @@index([userId])
  @@index([status])
  @@index([carrierName])
  @@map("contracts")
}

// ============================================
// QUOTES & ILLUSTRATIONS
// ============================================

enum QuoteType {
  TERM_LIFE
  WHOLE_LIFE
  UNIVERSAL_LIFE
  INDEXED_UNIVERSAL_LIFE
  VARIABLE_LIFE
  FIXED_ANNUITY
  INDEXED_ANNUITY
  VARIABLE_ANNUITY
}

enum QuoteStatus {
  DRAFT
  GENERATED
  SENT
  APPLIED
  EXPIRED
}

model Quote {
  id              String       @id @default(uuid())
  userId          String
  user            User         @relation(fields: [userId], references: [id])

  // Client Information
  clientName      String
  clientEmail     String?
  clientPhone     String?
  clientAge       Int
  clientState     String

  // Quote Details
  type            QuoteType
  carrier         String
  productName     String
  coverageAmount  Float?
  premium         Float
  term            Int?         // Term length in years

  status          QuoteStatus  @default(DRAFT)
  externalId      String?      // ID from third-party system (WinFlex, iPipeline, etc.)
  pdfUrl          String?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  expiresAt       DateTime?

  // Relations
  cases           Case[]

  @@index([userId])
  @@index([status])
  @@index([type])
  @@map("quotes")
}

// ============================================
// CASES & APPLICATIONS
// ============================================

enum CaseStatus {
  DRAFT
  SUBMITTED
  PENDING_REQUIREMENTS
  IN_UNDERWRITING
  APPROVED
  ISSUED
  DECLINED
  WITHDRAWN
}

model Case {
  id                String       @id @default(uuid())
  userId            String
  user              User         @relation(fields: [userId], references: [id])
  quoteId           String?
  quote             Quote?       @relation(fields: [quoteId], references: [id])

  // Client Information
  clientName        String
  clientEmail       String?
  clientPhone       String?

  // Case Details
  carrier           String
  productType       String
  productName       String
  applicationNumber String?
  policyNumber      String?
  coverageAmount    Float?
  premium           Float?

  status            CaseStatus   @default(DRAFT)
  statusNotes       String?      @db.Text

  // Requirements & Documents
  pendingRequirements String[]
  documentUrls        String[]

  // External System References
  externalId          String?    // ID from iGo, Firelight, etc.
  externalSystem      String?    // iGo, Firelight, Smart Office, etc.

  submittedAt       DateTime?
  approvedAt        DateTime?
  issuedAt          DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Relations
  notes             CaseNote[]
  commissions       Commission[]

  @@index([userId])
  @@index([status])
  @@index([carrier])
  @@map("cases")
}

model CaseNote {
  id        String   @id @default(uuid())
  caseId    String
  case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  content   String   @db.Text
  isInternal Boolean @default(false)
  createdBy String
  createdAt DateTime @default(now())

  @@index([caseId])
  @@map("case_notes")
}

// ============================================
// COMMISSIONS
// ============================================

enum CommissionStatus {
  PENDING
  PAID
  ADJUSTED
  DISPUTED
}

enum CommissionType {
  FIRST_YEAR
  RENEWAL
  OVERRIDE
  BONUS
  TRAIL
}

model Commission {
  id              String           @id @default(uuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id])
  caseId          String?
  case            Case?            @relation(fields: [caseId], references: [id])

  type            CommissionType
  status          CommissionStatus @default(PENDING)

  carrier         String
  policyNumber    String?

  amount          Float
  percentage      Float?
  splitAmount     Float?           // Amount after hierarchy splits

  periodStart     DateTime
  periodEnd       DateTime

  paidAt          DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([userId])
  @@index([status])
  @@index([caseId])
  @@map("commissions")
}

// ============================================
// NOTIFICATIONS & AUDIT
// ============================================

enum NotificationType {
  CASE_UPDATE
  CONTRACT_UPDATE
  COMMISSION_PAID
  TRAINING_ASSIGNED
  SYSTEM_ALERT
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      NotificationType
  title     String
  message   String           @db.Text
  link      String?

  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  action      String   // LOGIN, CREATE_CASE, UPDATE_CONTRACT, etc.
  entityType  String?  // User, Case, Contract, etc.
  entityId    String?

  changes     Json?    // Store before/after values
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// GOALS & PERFORMANCE TRACKING
// ============================================

enum GoalType {
  COMMISSION
  CASES
  PRODUCTION
}

model Goal {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?
  type        GoalType
  target      Float     // Target amount or count
  startDate   DateTime
  endDate     DateTime

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([type])
  @@index([startDate])
  @@index([endDate])
  @@map("goals")
}

// ============================================
// LEARNING MANAGEMENT SYSTEM (LMS)
// ============================================

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum LessonType {
  VIDEO
  ARTICLE
  QUIZ
  ASSIGNMENT
  LIVE_SESSION
}

enum EnrollmentStatus {
  ENROLLED
  IN_PROGRESS
  COMPLETED
  FAILED
  DROPPED
}

model Course {
  id              String        @id @default(uuid())
  title           String
  description     String        @db.Text
  thumbnail       String?
  level           CourseLevel   @default(BEGINNER)
  status          CourseStatus  @default(DRAFT)
  category        String
  tags            String[]
  duration        Int?          // In minutes
  requiredScore   Int           @default(70) // Percentage to pass

  instructorId    String
  instructor      User          @relation("InstructorCourses", fields: [instructorId], references: [id])

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  publishedAt     DateTime?

  // Relations
  lessons         Lesson[]
  enrollments     Enrollment[]
  certifications  Certification[]

  @@index([status])
  @@index([category])
  @@index([instructorId])
  @@map("courses")
}

model Lesson {
  id              String      @id @default(uuid())
  courseId        String
  course          Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)

  title           String
  description     String?     @db.Text
  type            LessonType
  order           Int
  duration        Int?        // In minutes

  // Content
  videoUrl        String?
  articleContent  String?     @db.Text
  attachments     String[]    // URLs to files

  // Quiz data (if type is QUIZ)
  quizData        Json?

  isRequired      Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  progress        LessonProgress[]

  @@index([courseId])
  @@index([type])
  @@map("lessons")
}

model Enrollment {
  id              String            @id @default(uuid())
  userId          String
  user            User              @relation("UserEnrollments", fields: [userId], references: [id], onDelete: Cascade)
  courseId        String
  course          Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)

  status          EnrollmentStatus  @default(ENROLLED)
  progress        Int               @default(0) // Percentage
  score           Int?              // Final score percentage

  enrolledAt      DateTime          @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  certificateId   String?           @unique
  certificate     Certification?    @relation(fields: [certificateId], references: [id])

  // Relations
  lessonProgress  LessonProgress[]

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@map("enrollments")
}

model LessonProgress {
  id              String      @id @default(uuid())
  enrollmentId    String
  enrollment      Enrollment  @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lessonId        String
  lesson          Lesson      @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  completed       Boolean     @default(false)
  score           Int?        // For quizzes
  timeSpent       Int?        // In seconds
  attempts        Int         @default(0)

  startedAt       DateTime    @default(now())
  completedAt     DateTime?

  @@unique([enrollmentId, lessonId])
  @@index([enrollmentId])
  @@index([lessonId])
  @@map("lesson_progress")
}

model Certification {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation("UserCertifications", fields: [userId], references: [id], onDelete: Cascade)
  courseId        String
  course          Course      @relation(fields: [courseId], references: [id])

  certificateNumber String    @unique
  title           String
  issueDate       DateTime    @default(now())
  expiryDate      DateTime?
  score           Int

  pdfUrl          String?
  verificationUrl String?

  enrollment      Enrollment?

  @@index([userId])
  @@index([courseId])
  @@map("certifications")
}

model TrainingEvent {
  id              String      @id @default(uuid())
  title           String
  description     String?     @db.Text
  courseId        String?

  startDate       DateTime
  endDate         DateTime
  location        String?     // "Virtual" or physical address
  meetingUrl      String?
  capacity        Int?

  instructorId    String
  instructor      User        @relation("InstructorEvents", fields: [instructorId], references: [id])

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  attendees       EventAttendee[]

  @@index([startDate])
  @@index([instructorId])
  @@map("training_events")
}

model EventAttendee {
  id              String        @id @default(uuid())
  eventId         String
  event           TrainingEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId          String
  user            User          @relation("EventAttendances", fields: [userId], references: [id], onDelete: Cascade)

  registered      Boolean       @default(true)
  attended        Boolean       @default(false)
  registeredAt    DateTime      @default(now())

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@map("event_attendees")
}

// ============================================
// RESOURCE LIBRARY
// ============================================

enum ResourceType {
  MARKETING_MATERIAL
  PRODUCT_INFO
  FORM
  TRAINING_DOC
  POLICY_TEMPLATE
  PRESENTATION
  OTHER
}

enum ResourceStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Resource {
  id              String          @id @default(uuid())
  title           String
  description     String?         @db.Text
  type            ResourceType
  status          ResourceStatus  @default(PUBLISHED)
  category        String
  tags            String[]

  // File info
  fileUrl         String
  fileName        String
  fileSize        Int             // In bytes
  mimeType        String

  // Version control
  version         Int             @default(1)
  previousVersionId String?       @unique
  previousVersion   Resource?     @relation("ResourceVersions", fields: [previousVersionId], references: [id])
  nextVersion       Resource?     @relation("ResourceVersions")

  // Metadata
  uploadedBy      String
  uploader        User            @relation("UploadedResources", fields: [uploadedBy], references: [id])

  views           Int             @default(0)
  downloads       Int             @default(0)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  favorites       ResourceFavorite[]

  @@index([type])
  @@index([status])
  @@index([category])
  @@index([uploadedBy])
  @@map("resources")
}

model ResourceFavorite {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation("FavoriteResources", fields: [userId], references: [id], onDelete: Cascade)
  resourceId      String
  resource        Resource    @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  createdAt       DateTime    @default(now())

  @@unique([userId, resourceId])
  @@index([userId])
  @@index([resourceId])
  @@map("resource_favorites")
}

model ProductInfo {
  id              String      @id @default(uuid())
  carrier         String
  productName     String
  productType     String      // TERM_LIFE, WHOLE_LIFE, ANNUITY, etc.

  description     String      @db.Text
  features        String[]
  benefits        String[]
  riders          String[]

  minAge          Int?
  maxAge          Int?
  minCoverage     Float?
  maxCoverage     Float?

  commissionRates Json?       // Structure: { first_year: 90, renewal: 5 }
  underwritingRequirements Json?

  brochureUrl     String?
  illustrationUrl String?
  applicationUrl  String?

  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([carrier])
  @@index([productType])
  @@index([isActive])
  @@map("product_info")
}

// ============================================
// HELP CENTER & DOCUMENTATION
// ============================================

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ArticleCategory {
  GETTING_STARTED
  CASES
  COMMISSIONS
  QUOTES
  CONTRACTS
  TRAINING
  REPORTS
  INTEGRATIONS
  TROUBLESHOOTING
  BEST_PRACTICES
  COMPLIANCE
  ADMIN
}

model HelpArticle {
  id              String          @id @default(uuid())
  title           String
  slug            String          @unique
  category        ArticleCategory
  tags            String[]

  // Content
  summary         String          @db.Text
  content         String          @db.Text // Markdown format
  videoUrl        String?
  attachments     String[]        // URLs to supplementary files

  // SEO & Search
  keywords        String[]
  searchableText  String          @db.Text // Auto-generated from content

  // Organization
  order           Int             @default(0)
  parentId        String?
  parent          HelpArticle?    @relation("ArticleHierarchy", fields: [parentId], references: [id])
  children        HelpArticle[]   @relation("ArticleHierarchy")
  relatedArticles String[]        // IDs of related articles

  // Metadata
  status          ArticleStatus   @default(DRAFT)
  authorId        String
  lastEditedBy    String?
  views           Int             @default(0)
  helpfulCount    Int             @default(0)
  notHelpfulCount Int             @default(0)

  publishedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  feedback        ArticleFeedback[]

  @@index([slug])
  @@index([category])
  @@index([status])
  @@index([publishedAt])
  @@index([parentId])
  @@map("help_articles")
}

model ArticleFeedback {
  id              String      @id @default(uuid())
  articleId       String
  article         HelpArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  userId          String?

  helpful         Boolean
  comment         String?     @db.Text

  createdAt       DateTime    @default(now())

  @@index([articleId])
  @@index([helpful])
  @@map("article_feedback")
}

model FAQ {
  id              String      @id @default(uuid())
  question        String
  answer          String      @db.Text
  category        String
  order           Int         @default(0)

  views           Int         @default(0)
  helpfulCount    Int         @default(0)

  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([category])
  @@index([isActive])
  @@map("faqs")
}
